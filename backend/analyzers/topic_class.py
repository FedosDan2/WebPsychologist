import json
import os
from collections import Counter
import re

class TopicAnalyzer:
    """Анализатор тематики и эмоциональных паттернов в диалогах.

    Класс позволяет извлекать темы (например, «работа», «семья») и эмоциональные категории
    (например, «поддержка», «конфликт») из текстовых сообщений на основе заранее заданных
    словарей ключевых слов и устойчивых фраз. Поддерживает агрегацию по участникам диалога
    и анализ переходов между темами.

    Атрибуты:
        topic_keywords (dict): Словарь тем → списки ключевых слов.
        emotion_patterns (dict): Словарь эмоциональных категорий → списки фраз-паттернов.
    """
    def __init__(self):
        # Ключевые слова для определения тем
        self.topic_keywords = {
            'работа': [
                'работа', 'проект', 'задача', 'дедлайн', 'начальник', 'коллега',
                'отчёт', 'презентация', 'совещание', 'зарплата', 'офис', 'удалёнка',
                'карьера', 'обязанности', 'график', 'смена', 'бриф', 'квартал',
                'KPI', 'продуктивность', 'митинг', 'встреча', 'руководитель', 'подчинённый',
                'резюме', 'собеседование', 'увольнение', 'найм', 'фриланс', 'контракт'
            ],

            'семья': [
                'семья', 'дети', 'ребёнок', 'муж', 'жена', 'родители', 'мама', 'папа',
                'бабушка', 'дедушка', 'родные', 'домашние', 'семейный',
                'воспитание', 'отношения', 'любовь', 'супруг', 'супруга', 'сын', 'дочь',
                'внуки', 'свадьба', 'рождение', 'именины', 'вечер вместе', 'семейный ужин'
            ],

            'быт': [
                'дом', 'квартира', 'уборка', 'готовка', 'покупки', 'магазин', 'еда',
                'ужин', 'завтрак', 'стирка', 'ремонт', 'мебель', 'техника',
                'хозяйство', 'расходники', 'счётчики', 'коммуналка', 'мусор', 'посуда',
                'холодильник', 'стиральная машина', 'приготовление', 'обед', 'пол',
                'окна', 'мытьё', 'порошок', 'средства', 'покупка продуктов'
            ],

            'отдых': [
                'отдых', 'отпуск', 'каникулы', 'путешествие', 'поездка', 'море',
                'горы', 'отель', 'билеты', 'экскурсия', 'развлечения', 'кино', 'ресторан',
                'парк', 'музей', 'выходные', 'пикник', 'природа', 'туризм', 'палатка',
                'кемпинг', 'фестиваль', 'концерт', 'выставка', 'сауна', 'спа', 'йога'
            ],

            'здоровье': [
                'здоровье', 'болезнь', 'врач', 'больница', 'лекарство', 'температура',
                'грипп', 'простуда', 'аптека', 'анализы', 'операция', 'диета', 'спорт',
                'иммунитет', 'сон', 'утомление', 'усталость', 'реабилитация', 'профилактика',
                'симптомы', 'диагноз', 'терапия', 'стоматолог', 'фитнес', 'витамины',
                'артериальное давление', 'кашель', 'насморк', 'лечение', 'здоровый образ жизни'
            ],

            'финансы': [
                'деньги', 'зарплата', 'бюджет', 'экономия', 'траты', 'покупка',
                'цена', 'стоимость', 'кредит', 'ипотека', 'сбережения', 'инвестиции',
                'доход', 'расход', 'налоги', 'счёт', 'банкомат', 'карта', 'платёж',
                'перевод', 'долг', 'проценты', 'финансовая грамотность', 'накопления',
                'расходы на еду', 'счёт в банке', 'обмен валюты', 'страховка'
            ],

            'планы': [
                'планы', 'цели', 'мечты', 'будущее', 'перспективы', 'намерения',
                'ожидания', 'расчеты', 'стратегия', 'график', 'расписание',
                'дорожная карта', 'этапы', 'сроки', 'приоритеты', 'целеполагание',
                'планирование', 'предстоящее', 'намечать', 'реализация', 'ориентир'
            ],

            'проблемы': [
                'проблема', 'трудность', 'сложность', 'затруднение', 'препятствие',
                'конфликт', 'спор', 'непонимание', 'обида', 'разочарование', 'стресс',
                'кризис', 'напряжение', 'ошибка', 'провал', 'давление', 'неудача',
                'разногласия', 'волнение', 'тревога', 'заминка', 'аврал', 'перегруз'
            ],

            'поддержка': [
                'помощь', 'поддержка', 'совет', 'рекомендация', 'подсказка',
                'содействие', 'взаимопомощь', 'забота', 'внимание', 'понимание',
                'моральная поддержка', 'выручка', 'присутствие', 'сочувствие',
                'сострадание', 'надёжность', 'выслушать', 'ободрение', 'тёплые слова',
                'дружба', 'эмпатия', 'опора', 'доверие'
            ],

            'радость': [
                'радость', 'счастье', 'успех', 'победа', 'достижение', 'праздник',
                'подарок', 'сюрприз', 'восторг', 'восхищение', 'гордость',
                'ликование', 'удовольствие', 'настроение', 'вдохновение', 'гармония',
                'празднование', 'день рождения', 'юбилей', 'любимое занятие', 'улыбка',
                'позитив', 'эйфория', 'благодарность', 'признание', 'комплимент'
            ]
        }
                
        # Эмоциональные паттерны для тем
        self.emotion_patterns = {
            'конфликт': [
                'ты виноват', 'почему ты', 'опять ты', 'вечно ты', 'не могу больше',
                'хватит уже', 'довел до белого каления', 'все из-за тебя', 'ты опять всё испортил',
                'я больше так не могу', 'прекрати немедленно', 'ты никогда не слушаешь',
                'меня это бесит', 'ты нарываешься', 'довольно этого', 'я вымотан из-за тебя',
                'всё пошло наперекосяк', 'это возмутительно', 'как ты мог?', 'я в ярости',
                'никогда больше', 'не лезь ко мне', 'отвали', 'устал от твоих выходок'
            ],

            'поддержка': [
                'всё будет хорошо', 'я помогу', 'не переживай', 'я с тобой', 'держись',
                'ты справишься', 'я верю в тебя', 'всё наладится', 'я рядом', 'не бойся',
                'опора и поддержка', 'ты не один', 'всё пройдёт', 'я за тебя', 'всё уладится',
                'если что — зови', 'я всегда на твоей стороне', 'не грусти', 'ты молодец',
                'держись, скоро легче станет', 'всё получится', 'я тебя понимаю', 'не сдавайся'
            ],

            'благодарность': [
                'спасибо', 'благодарю', 'ценю', 'признателен', 'обязан',
                'огромное спасибо', 'спасибо тебе', 'ты здорово помог', 'не знаю, как отблагодарить',
                'сердечное спасибо', 'благодарен от души', 'ты меня выручил', 'это очень ценно',
                'благодарю за заботу', 'спасибо за поддержку', 'ты настоящий друг', 'я в долгу',
                'невероятно благодарен', 'ты сделал мой день', 'это так мило с твоей стороны',
                'от всей души благодарю', 'спасибо, что ты есть'
            ],

            'просьба': [
                'пожалуйста', 'мог бы ты', 'не мог бы', 'помоги', 'сделай',
                'не откажи в помощи', 'будь добр', 'можно тебя попросить', 'ты не мог бы',
                'одолжи, пожалуйста', 'поможешь?', 'если не сложно', 'не затруднит ли',
                'прошу тебя', 'сделай одолжение', 'может, поможешь?', 'подскажи, пожалуйста',
                'не сочти за труд', 'выйди на связь, пожалуйста', 'не забудь, пожалуйста',
                'пожалуйста, помоги', 'давай договоримся', 'не мог бы ты глянуть?'
            ],

            'извинение': [
                'извини', 'прости', 'виноват', 'сожалею', 'pardon',
                'прости меня', 'извиняюсь', 'я был неправ', 'прошу прощения', 'это моя вина',
                'не злися', 'я не хотел', 'пожалуйста, прости', 'я облажался', 'мне стыдно',
                'приношу свои извинения', 'прошу понять и простить', 'я ошибся', 'прости за беспокойство',
                'сожалею о случившемся', 'надеюсь, ты простишь', 'я раскаиваюсь', 'это вышло случайно',
                'не держи зла', 'я погорячился', 'обещаю это больше не повторится'
            ]
        }
    
    def _extract_topics_from_text(self, text):
        """Извлекает темы и эмоциональные категории из одного текстового сообщения.

        Метод ищет вхождения ключевых слов из `self.topic_keywords` и фраз из
        `self.emotion_patterns` в нижнем регисте. Каждая тема или эмоция засчитывается
        максимум один раз на сообщение.

        Args:
            text (str): Текст сообщения для анализа.

        Returns:
            list[str]: Список уникальных найденных тем и эмоциональных категорий.
        """
        text = text.lower()
        found_topics = []
        
        # Ищем ключевые слова тем
        for topic, keywords in self.topic_keywords.items():
            for keyword in keywords:
                if keyword in text:
                    found_topics.append(topic)
                    break  # Нашли хоть одно слово - тема присутствует
        
        # Ищем эмоциональные паттерны
        for emotion, patterns in self.emotion_patterns.items():
            for pattern in patterns:
                if pattern in text:
                    found_topics.append(emotion)
                    break
        
        return list(set(found_topics))  # Убираем дубли
    
    def _analyze_dialog_topics(self, messages, participants=None):
        """Анализирует распределение тем по всему диалогу и по отдельным участникам.

        Собирает частотность упоминаний тем, определяет доминирующие темы (встречающиеся
        как минимум дважды) и выявляет основные интересы каждого участника.

        Args:
            messages (list[dict]): Список сообщений, где каждое сообщение — словарь
                с ключами 'text' (str) и 'sender' (str).
            participants (list[str], optional): Список имён участников, для которых"работа": 4,
                требуется детальный анализ. Если None — анализ по отправителям не производится.

        Returns:
            dict: Словарь с ключами:
                - 'all_topics' (dict[str, int]): Общая частотность всех тем.
                - 'dominant_topics' (list[dict]): Список доминирующих тем, каждый элемент — 
                  словарь с ключами 'topic', 'count', 'percentage'.
                - 'total_messages_analyzed' (int): Общее число обработанных сообщений.
                - 'participant_interests' (dict): Интересы участников, где ключ — имя,
                  значение — словарь с 'main_interest' и 'all_topics' (частоты).
        """
        all_topics = []
        topics_by_participant = {}
        
        if participants:
            for participant in participants:
                topics_by_participant[participant] = []
        
        for message in messages:
            text = message.get('text', '')
            sender = message.get('sender', '')
            
            message_topics = self._extract_topics_from_text(text)
            all_topics.extend(message_topics)
            
            if sender in topics_by_participant:
                topics_by_participant[sender].extend(message_topics)
        
        # Подсчитываем частоту тем
        topic_frequencies = Counter(all_topics)
        
        # Определяем доминирующие темы (больше 2 упоминаний)
        dominant_topics = []
        for topic, count in topic_frequencies.most_common(5):
            if count >= 2:  # Минимум 2 упоминания
                percentage = (count / len(all_topics)) * 100 if all_topics else 0
                dominant_topics.append({
                    'topic': topic,
                    'count': count,
                    'percentage': round(percentage, 1)
                })
        
        # Анализируем интересы участников
        participant_interests = {}
        for participant, topics in topics_by_participant.items():
            if topics:
                topic_counter = Counter(topics)
                main_topic = topic_counter.most_common(1)[0][0] if topic_counter else 'не определено'
                participant_interests[participant] = {
                    'main_interest': main_topic,
                    'all_topics': dict(topic_counter)
                }
        
        return {
            'dominant_topics': dominant_topics,
            'total_messages_analyzed': len(messages),
            'participant_interests': participant_interests
        }
    
    def _get_topic_transitions(self, messages):
        """Отслеживает последовательные переходы между темами в хронологическом порядке.

        Для каждого сообщения (начиная со второго) определяется первая найденная тема.
        Если она отличается от темы предыдущего сообщения, фиксируется переход.

        Args:
            messages (list[dict]): Список сообщений с ключами 'text'.

        Returns:
            list[dict]: Список переходов, каждый элемент содержит:
                - 'from' (str): Тема предыдущего сообщения.
                - 'to' (str): Тема текущего сообщения.
                - 'message_index' (int): Индекс сообщения, в котором произошёл переход.
        """
        transitions = []
        previous_topic = None
        
        for i, message in enumerate(messages):
            if i > 0:  # Начиная со второго сообщения
                text = message.get('text', '')
                current_topics = self._extract_topics_from_text(text)
                
                if current_topics and previous_topic:
                    if current_topics[0] != previous_topic:
                        transitions.append({
                            'from': previous_topic,
                            'to': current_topics[0],
                            'message_index': i
                        })
                
                if current_topics:
                    previous_topic = current_topics[0]
        
        return transitions
    
    def analyze(self, messages, participants=None):
        """
        Анализирует список сообщений и возвращает структурированный отчёт о темах.
        
        Args:
            messages (list): Список словарей с ключами 'text' и 'sender'
            participants (list, optional): Список имён участников для детального анализа
        
        Returns:
            dict: Словарь с ключами:
                - 'all_topics': частотность всех найденных тем
                - 'dominant_topics': список доминирующих тем (>=2 упоминаний)
                - 'total_messages_analyzed': общее число проанализированных сообщений
                - 'participant_interests': интересы участников по темам
                - 'topic_transitions': список переходов между темами
        """
        # Анализ основных тем и интересов участников
        topic_results = self._analyze_dialog_topics(messages, participants)
        
        # Анализ переходов между темами
        #transitions = self._get_topic_transitions(messages)
        
        # Объединяем результаты
        return {
            'dominant_topics': topic_results['dominant_topics'],
            'total_messages_analyzed': topic_results['total_messages_analyzed'],
            'participant_interests': topic_results['participant_interests']
            #'topic_transitions': transitions
        }
